// services/database.js - Roz≈°√≠≈ôen√Ω datab√°zov√Ω servis s user management
const sqlite3 = require('sqlite3').verbose();
const path = require('path');
const fs = require('fs');

// Cesta k datab√°zi
const DB_PATH = path.join(__dirname, '..', 'data', 'friends.db');

// Ujistit se, ≈æe slo≈æka data existuje
const dataDir = path.dirname(DB_PATH);
if (!fs.existsSync(dataDir)) {
    fs.mkdirSync(dataDir, { recursive: true });
    console.log('Vytvo≈ôena slo≈æka pro datab√°zi:', dataDir);
}

// Vytvo≈ôen√≠ datab√°ze
const db = new sqlite3.Database(DB_PATH, (err) => {
    if (err) {
        console.error('Chyba p≈ôi p≈ôipojov√°n√≠ k datab√°zi friends:', err);
    } else {
        console.log('‚úÖ P≈ôipojeno k SQLite datab√°zi friends:', DB_PATH);
        initializeDatabase();
    }
});

// Inicializace datab√°zov√Ωch tabulek
function initializeDatabase() {
    console.log('üîÑ Inicializace datab√°zov√Ωch tabulek...');
    
    // Tabulka pro u≈æivatele - NOV√Å!
    db.run(`
        CREATE TABLE IF NOT EXISTS users (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            steam_id TEXT UNIQUE NOT NULL,
            display_name TEXT NOT NULL,
            avatar_url TEXT,
            profile_url TEXT,
            is_admin BOOLEAN DEFAULT 0,
            first_login DATETIME DEFAULT CURRENT_TIMESTAMP,
            last_login DATETIME DEFAULT CURRENT_TIMESTAMP,
            last_seen_online DATETIME,
            total_logins INTEGER DEFAULT 1,
            is_active BOOLEAN DEFAULT 1,
            created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
            updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
        )
    `, (err) => {
        if (err) {
            console.error('Chyba p≈ôi vytv√°≈ôen√≠ tabulky users:', err);
        } else {
            console.log('‚úÖ Tabulka users je p≈ôipravena');
        }
    });
    
    // Tabulka pro p≈ô√°tel√© a ≈æ√°dosti o p≈ô√°telstv√≠ - ROZ≈†√ç≈òEN√Å
    db.run(`
        CREATE TABLE IF NOT EXISTS friends (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            user_id TEXT NOT NULL,
            friend_id TEXT NOT NULL,
            user_name TEXT,
            friend_name TEXT,
            user_permissions TEXT DEFAULT '{"location":true,"stats":false}',
            friend_permissions TEXT DEFAULT '{"location":true,"stats":false}',
            status TEXT DEFAULT 'pending',
            created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
            updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
            FOREIGN KEY (user_id) REFERENCES users(steam_id),
            FOREIGN KEY (friend_id) REFERENCES users(steam_id)
        )
    `, (err) => {
        if (err) {
            console.error('Chyba p≈ôi vytv√°≈ôen√≠ tabulky friends:', err);
        } else {
            console.log('‚úÖ Tabulka friends je p≈ôipravena');
        }
    });
    
    // Indexy pro rychl√© vyhled√°v√°n√≠
    const indexes = [
        'CREATE INDEX IF NOT EXISTS idx_users_steam_id ON users(steam_id)',
        'CREATE INDEX IF NOT EXISTS idx_users_last_login ON users(last_login)',
        'CREATE INDEX IF NOT EXISTS idx_friends_user_id ON friends(user_id)',
        'CREATE INDEX IF NOT EXISTS idx_friends_friend_id ON friends(friend_id)',
        'CREATE INDEX IF NOT EXISTS idx_friends_status ON friends(status)'
    ];
    
    indexes.forEach(indexSql => {
        db.run(indexSql, (err) => {
            if (err) console.error('Chyba p≈ôi vytv√°≈ôen√≠ indexu:', err);
        });
    });
    
    // Triggery pro automatick√© update updated_at
    db.run(`
        CREATE TRIGGER IF NOT EXISTS users_updated_at 
        AFTER UPDATE ON users
        BEGIN
            UPDATE users SET updated_at = CURRENT_TIMESTAMP WHERE id = NEW.id;
        END
    `);
    
    db.run(`
        CREATE TRIGGER IF NOT EXISTS friends_updated_at 
        AFTER UPDATE ON friends
        BEGIN
            UPDATE friends SET updated_at = CURRENT_TIMESTAMP WHERE id = NEW.id;
        END
    `);
    
    console.log('‚úÖ Datab√°zov√© indexy a triggery vytvo≈ôeny');
}

// Funkce pro parsov√°n√≠ permissions z JSON stringu
function parsePermissions(permissionsString) {
    try {
        if (!permissionsString) {
            return { location: true, stats: false };
        }
        
        const permissions = JSON.parse(permissionsString);
        
        return {
            location: Boolean(permissions.location !== undefined ? permissions.location : true),
            stats: Boolean(permissions.stats !== undefined ? permissions.stats : false)
        };
    } catch (error) {
        console.error('Chyba p≈ôi parsov√°n√≠ permissions:', error);
        return { location: true, stats: false };
    }
}

// Funkce pro serializaci permissions do JSON stringu
function serializePermissions(permissions) {
    try {
        const perms = permissions || { location: true, stats: false };
        return JSON.stringify({
            location: Boolean(perms.location),
            stats: Boolean(perms.stats)
        });
    } catch (error) {
        console.error('Chyba p≈ôi serializaci permissions:', error);
        return JSON.stringify({ location: true, stats: false });
    }
}

// NOV√â funkce pro spr√°vu u≈æivatel≈Ø

// Vytvo≈ôen√≠ nebo aktualizace u≈æivatele p≈ôi p≈ôihl√°≈°en√≠
function createOrUpdateUser(steamProfile, adminSteamIds = []) {
    return new Promise((resolve, reject) => {
        const steamId = steamProfile.id;
        const displayName = steamProfile.displayName || `Player ${steamId}`;
        const avatarUrl = steamProfile.photos && steamProfile.photos.length > 0 ? steamProfile.photos[0].value : null;
        const profileUrl = steamProfile.profileUrl || `https://steamcommunity.com/profiles/${steamId}`;
        const isAdmin = adminSteamIds.includes(steamId);
        
        console.log(`üë§ Zpracov√°v√°m u≈æivatele: ${displayName} (${steamId}), Admin: ${isAdmin}`);
        
        // Nejd≈ô√≠ve zkusit naj√≠t existuj√≠c√≠ho u≈æivatele
        db.get(`
            SELECT * FROM users WHERE steam_id = ?
        `, [steamId], (err, existingUser) => {
            if (err) {
                console.error('Chyba p≈ôi hled√°n√≠ u≈æivatele:', err);
                return reject(err);
            }
            
            if (existingUser) {
                // Aktualizovat existuj√≠c√≠ho u≈æivatele
                console.log(`üîÑ Aktualizuji existuj√≠c√≠ho u≈æivatele: ${displayName}`);
                
                db.run(`
                    UPDATE users 
                    SET display_name = ?, 
                        avatar_url = ?, 
                        profile_url = ?,
                        is_admin = ?,
                        last_login = CURRENT_TIMESTAMP,
                        total_logins = total_logins + 1,
                        is_active = 1
                    WHERE steam_id = ?
                `, [displayName, avatarUrl, profileUrl, isAdmin, steamId], function(updateErr) {
                    if (updateErr) {
                        console.error('Chyba p≈ôi aktualizaci u≈æivatele:', updateErr);
                        return reject(updateErr);
                    }
                    
                    console.log(`‚úÖ U≈æivatel aktualizov√°n: ${displayName}`);
                    
                    // Vr√°tit aktualizovan√©ho u≈æivatele
                    db.get(`SELECT * FROM users WHERE steam_id = ?`, [steamId], (selectErr, updatedUser) => {
                        if (selectErr) {
                            return reject(selectErr);
                        }
                        resolve(updatedUser);
                    });
                });
            } else {
                // Vytvo≈ôit nov√©ho u≈æivatele
                console.log(`‚ú® Vytv√°≈ô√≠m nov√©ho u≈æivatele: ${displayName}`);
                
                db.run(`
                    INSERT INTO users (
                        steam_id, display_name, avatar_url, profile_url, is_admin,
                        first_login, last_login, total_logins, is_active
                    ) VALUES (?, ?, ?, ?, ?, CURRENT_TIMESTAMP, CURRENT_TIMESTAMP, 1, 1)
                `, [steamId, displayName, avatarUrl, profileUrl, isAdmin], function(insertErr) {
                    if (insertErr) {
                        console.error('Chyba p≈ôi vytv√°≈ôen√≠ u≈æivatele:', insertErr);
                        return reject(insertErr);
                    }
                    
                    console.log(`‚úÖ Nov√Ω u≈æivatel vytvo≈ôen: ${displayName} (ID: ${this.lastID})`);
                    
                    // Vr√°tit nov√©ho u≈æivatele
                    db.get(`SELECT * FROM users WHERE id = ?`, [this.lastID], (selectErr, newUser) => {
                        if (selectErr) {
                            return reject(selectErr);
                        }
                        resolve(newUser);
                    });
                });
            }
        });
    });
}

// Z√≠sk√°n√≠ u≈æivatele podle Steam ID
function getUserBySteamId(steamId) {
    return new Promise((resolve, reject) => {
        db.get(`
            SELECT * FROM users WHERE steam_id = ? AND is_active = 1
        `, [steamId], (err, user) => {
            if (err) {
                console.error('Chyba p≈ôi naƒç√≠t√°n√≠ u≈æivatele:', err);
                return reject(err);
            }
            resolve(user);
        });
    });
}

// Aktualizace posledn√≠ho online ƒçasu u≈æivatele
function updateUserLastSeen(steamId) {
    return new Promise((resolve, reject) => {
        db.run(`
            UPDATE users 
            SET last_seen_online = CURRENT_TIMESTAMP 
            WHERE steam_id = ?
        `, [steamId], function(err) {
            if (err) {
                console.error('Chyba p≈ôi aktualizaci last_seen:', err);
                return reject(err);
            }
            resolve(this.changes > 0);
        });
    });
}

// Vyhled√°n√≠ u≈æivatel≈Ø podle jm√©na (pro friend requests)
function searchUsersByName(searchTerm, limit = 10) {
    return new Promise((resolve, reject) => {
        const searchPattern = `%${searchTerm}%`;
        
        db.all(`
            SELECT steam_id, display_name, avatar_url, last_login, last_seen_online
            FROM users 
            WHERE display_name LIKE ? 
            AND is_active = 1
            ORDER BY last_login DESC 
            LIMIT ?
        `, [searchPattern, limit], (err, users) => {
            if (err) {
                console.error('Chyba p≈ôi vyhled√°v√°n√≠ u≈æivatel≈Ø:', err);
                return reject(err);
            }
            resolve(users || []);
        });
    });
}

// Z√≠sk√°n√≠ v≈°ech aktivn√≠ch u≈æivatel≈Ø (pro admin)
function getAllActiveUsers(limit = 100) {
    return new Promise((resolve, reject) => {
        db.all(`
            SELECT steam_id, display_name, avatar_url, is_admin, 
                   first_login, last_login, last_seen_online, total_logins
            FROM users 
            WHERE is_active = 1
            ORDER BY last_login DESC 
            LIMIT ?
        `, [limit], (err, users) => {
            if (err) {
                console.error('Chyba p≈ôi naƒç√≠t√°n√≠ v≈°ech u≈æivatel≈Ø:', err);
                return reject(err);
            }
            resolve(users || []);
        });
    });
}

// Funkce pro vyƒçi≈°tƒõn√≠ star√Ωch pending request≈Ø (star≈°√≠ch ne≈æ 30 dn√≠)
function cleanupOldRequests() {
    db.run(`
        DELETE FROM friends 
        WHERE status = 'pending' 
        AND created_at < datetime('now', '-30 days')
    `, function(err) {
        if (err) {
            console.error('Chyba p≈ôi ƒçi≈°tƒõn√≠ star√Ωch ≈æ√°dost√≠:', err);
        } else if (this.changes > 0) {
            console.log(`üßπ Vyƒçi≈°tƒõno ${this.changes} star√Ωch ≈æ√°dost√≠ o p≈ô√°telstv√≠`);
        }
    });
}

// Vyƒçi≈°tƒõn√≠ neaktivn√≠ch u≈æivatel≈Ø (nevidƒõni d√©le ne≈æ 6 mƒõs√≠c≈Ø)
function cleanupInactiveUsers() {
    db.run(`
        UPDATE users 
        SET is_active = 0 
        WHERE last_login < datetime('now', '-6 months')
        AND is_active = 1
    `, function(err) {
        if (err) {
            console.error('Chyba p≈ôi oznaƒçov√°n√≠ neaktivn√≠ch u≈æivatel≈Ø:', err);
        } else if (this.changes > 0) {
            console.log(`üßπ Oznaƒçeno ${this.changes} u≈æivatel≈Ø jako neaktivn√≠`);
        }
    });
}

// Spustit cleanup ka≈æd√Ωch 24 hodin
setInterval(() => {
    cleanupOldRequests();
    cleanupInactiveUsers();
}, 24 * 60 * 60 * 1000);

// Debug funkce pro v√Ωpis obsahu datab√°ze
function debugDatabase() {
    // Debug u≈æivatel√©
    db.all('SELECT steam_id, display_name, is_admin, last_login FROM users WHERE is_active = 1 ORDER BY last_login DESC LIMIT 5', (err, users) => {
        if (err) {
            console.error('Debug chyba (users):', err);
        } else {
            console.log('üîç Posledn√≠ch 5 aktivn√≠ch u≈æivatel≈Ø:');
            users.forEach(user => {
                console.log(`  ${user.display_name} (${user.steam_id}) - Admin: ${user.is_admin ? 'Ano' : 'Ne'} - Posledn√≠ login: ${user.last_login}`);
            });
        }
    });
    
    // Debug p≈ô√°telstv√≠
    db.all(`
        SELECT f.*, 
               u1.display_name as user_display_name,
               u2.display_name as friend_display_name
        FROM friends f
        LEFT JOIN users u1 ON f.user_id = u1.steam_id
        LEFT JOIN users u2 ON f.friend_id = u2.steam_id
        ORDER BY f.created_at DESC LIMIT 5
    `, (err, friends) => {
        if (err) {
            console.error('Debug chyba (friends):', err);
        } else {
            console.log('üîç Posledn√≠ch 5 z√°znam≈Ø p≈ô√°telstv√≠:');
            friends.forEach(friend => {
                console.log(`  ${friend.user_display_name || friend.user_name} -> ${friend.friend_display_name || friend.friend_name} (${friend.status})`);
            });
        }
    });
}

// Export funkc√≠ a datab√°ze
module.exports = {
    db,
    parsePermissions,
    serializePermissions,
    createOrUpdateUser,
    getUserBySteamId,
    updateUserLastSeen,
    searchUsersByName,
    getAllActiveUsers,
    cleanupOldRequests,
    cleanupInactiveUsers,
    debugDatabase
};

// Debug vypis p≈ôi startu serveru
setTimeout(() => {
    debugDatabase();
}, 2000);