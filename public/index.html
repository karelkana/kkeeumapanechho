<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Jursk√Ω Masakr - The Isle Evrima server od KarelKana.Eu</title>
<meta name="description" content="Ofici√°ln√≠ str√°nka Jursk√Ω Masakr - ƒçesk√Ω The Isle Evrima server. P≈ôipojte se k n√°m a za≈æijte dinosau≈ô√≠ p≈ôe≈æit√≠ naplno.">
<meta name="keywords" content="The Isle, Jursk√Ω Masakr, The Isle Evrima, ƒçesk√Ω The Isle server, dinosau≈ôi, KarelKana.Eu">
<meta name="robots" content="index, follow">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #2e2e2e;
            --secondary-color: #1a1a1a;
            --accent-color: #4CAF50;
            --accent-color-dark: #3e8e41;
            --text-color: #f0f0f0;
            --border-color: #444;
            --success-color: #4CAF50;
            --error-color: #f44336;
            --warning-color: #ff9800;
            --highlight-color: #2196F3;
            --carnivore-color: #f44336;
            --herbivore-color: #4CAF50;
            --other-color: #2196F3;
            --friend-color: #9c27b0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--secondary-color);
            color: var(--text-color);
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .navbar {
            background-color: var(--primary-color);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
        }

        .navbar h1 {
            margin: 0;
            font-size: 20px;
            display: flex;
            align-items: center;
        }

        .navbar h1 i {
            margin-right: 10px;
            color: var(--accent-color);
        }

        .server-status {
            display: flex;
            align-items: center;
            font-size: 14px;
            gap: 10px;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        .online {
            background-color: var(--success-color);
        }

        .offline {
            background-color: var(--error-color);
        }

        .content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .sidebar {
            width: 300px;
            background-color: var(--primary-color);
            padding: 20px;
            overflow-y: auto;
            border-right: 1px solid var(--border-color);
        }

        .auth-panel {
            background-color: rgba(0, 0, 0, 0.2);
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .auth-panel h3 {
            margin-top: 0;
            margin-bottom: 10px;
            font-size: 16px;
            display: flex;
            align-items: center;
        }

        .auth-panel h3 i {
            margin-right: 8px;
            color: var(--highlight-color);
        }

        .user-info {
            display: none;
        }

        .auth-panel-actions {
            display: flex;
            gap: 10px;
        }
        
        .friends-panel {
            background-color: rgba(0, 0, 0, 0.2);
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            display: none;
        }
        
        .friends-panel h3 {
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 16px;
            display: flex;
            align-items: center;
        }
        
        .friends-panel h3 i {
            margin-right: 8px;
            color: var(--friend-color);
        }
        
        .friends-list {
            max-height: 200px;
            overflow-y: auto;
        }
        
        .friend-item {
            padding: 8px 10px;
            border-left: 3px solid var(--friend-color);
            background-color: rgba(255, 255, 255, 0.05);
            margin-bottom: 8px;
            border-radius: 0 4px 4px 0;
            font-size: 14px;
            cursor: pointer;
            transition: background-color 0.2s;
            position: relative;
        }
        
        .friend-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        .friend-name {
            font-weight: bold;
            margin-bottom: 3px;
        }
        
        .friend-online {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 5px;
        }
        
        .friend-online.online {
            background-color: var(--success-color);
        }
        
        .friend-online.offline {
            background-color: #777;
        }
        
        .friend-remove {
            position: absolute;
            top: 8px;
            right: 8px;
            color: #aaa;
            cursor: pointer;
            font-size: 12px;
        }
        
        .friend-remove:hover {
            color: var(--error-color);
        }
        
        .add-friend-form {
            margin-top: 15px;
        }
        
        .add-friend-input {
            width: 100%;
            padding: 8px;
            background-color: rgba(255, 255, 255, 0.1);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            color: var(--text-color);
            box-sizing: border-box;
            margin-bottom: 8px;
        }
        
        .add-friend-btn {
            width: 100%;
            padding: 8px;
            background-color: var(--friend-color);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .add-friend-btn:hover {
            background-color: #7B1FA2;
        }

        /* NOV√â styly pro friend requests a cache status */
        .friend-requests-section {
            margin-bottom: 15px;
            padding: 10px;
            background-color: rgba(255, 193, 7, 0.1);
            border-left: 3px solid #ffc107;
            border-radius: 0 4px 4px 0;
        }

        .friend-outgoing-requests-section {
            margin-bottom: 15px;
            padding: 10px;
            background-color: rgba(33, 150, 243, 0.1);
            border-left: 3px solid #2196F3;
            border-radius: 0 4px 4px 0;
        }

        .friend-request-item {
            background-color: rgba(255, 255, 255, 0.05);
            padding: 8px;
            margin-bottom: 8px;
            border-radius: 4px;
        }

        .friend-request-buttons {
            display: flex;
            gap: 5px;
            margin-top: 5px;
        }

        .friend-request-btn {
            flex: 1;
            padding: 4px 8px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            color: white;
        }

        .friend-request-btn.accept {
            background-color: #4CAF50;
        }

        .friend-request-btn.reject {
            background-color: #f44336;
        }

        .friend-request-btn:hover {
            opacity: 0.8;
        }

        .friend-cancel-btn {
            padding: 4px 8px;
            background-color: #f44336;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            transition: background-color 0.2s;
        }

        .friend-cancel-btn:hover {
            background-color: #d32f2f;
        }

        .cache-indicator {
            position: absolute;
            top: 80px;
            right: 20px;
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            z-index: 100;
            display: none;
            animation: fadeInOut 3s ease-in-out;
        }

        @keyframes fadeInOut {
            0%, 100% { opacity: 0; }
            20%, 80% { opacity: 1; }
        }

        .friend-dialog-extended {
            width: 400px;
        }

        .friend-permission-options {
            margin: 15px 0;
            padding: 10px;
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
        }

        .permission-checkbox {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .permission-checkbox input {
            margin-right: 8px;
        }

        .server-status-extended {
            font-size: 12px;
        }

        .cache-warning {
            color: #ff9800;
            font-size: 11px;
            margin-left: 10px;
        }

        .notification-badge {
            background-color: #f44336;
            color: white;
            border-radius: 50%;
            padding: 2px 6px;
            font-size: 10px;
            margin-left: 5px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .filter-panel {
            background-color: rgba(0, 0, 0, 0.2);
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }

        .filter-panel h3 {
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 16px;
            display: flex;
            align-items: center;
        }

        .filter-panel h3 i {
            margin-right: 8px;
            color: var(--warning-color);
        }

        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 10px;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            font-size: 14px;
            cursor: pointer;
        }

        .checkbox-label input {
            margin-right: 5px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 14px;
        }

        .form-group input[type="text"] {
            width: 100%;
            padding: 8px;
            background-color: rgba(255, 255, 255, 0.1);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            color: var(--text-color);
            box-sizing: border-box;
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        .player-list {
            background-color: rgba(0, 0, 0, 0.2);
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }

        .player-list h3 {
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 16px;
            display: flex;
            align-items: center;
        }

        .player-list h3 i {
            margin-right: 8px;
            color: #9c27b0;
        }

        .dino-stats {
            background-color: rgba(0, 0, 0, 0.2);
            padding: 15px;
            border-radius: 5px;
        }

        .dino-stats h3 {
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 16px;
            display: flex;
            align-items: center;
        }

        .dino-stats h3 i {
            margin-right: 8px;
            color: var(--warning-color);
        }

        .dino-item {
            padding: 8px 10px;
            background-color: rgba(255, 255, 255, 0.05);
            margin-bottom: 8px;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .player-item {
            padding: 8px 10px;
            border-left: 3px solid var(--accent-color);
            background-color: rgba(255, 255, 255, 0.05);
            margin-bottom: 8px;
            border-radius: 0 4px 4px 0;
            font-size: 14px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .player-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        .player-item.player-friend {
            border-left-color: var(--friend-color);
        }

        .player-name {
            font-weight: bold;
            margin-bottom: 3px;
            display: flex;
            align-items: center;
        }
        
        .friend-icon {
            margin-left: 5px;
            color: var(--friend-color);
            font-size: 12px;
        }

        .player-details {
            font-size: 12px;
            color: #aaa;
        }

        .player-details span {
            margin-right: 10px;
        }
        
        .player-stats {
            margin-top: 5px;
            display: none;
        }
        
        .player-self .player-stats,
        .player-friend .player-stats {
            display: block;
        }
        
        .stat-bar {
            height: 6px;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            margin-bottom: 4px;
            overflow: hidden;
        }
        
        .stat-bar-fill {
            height: 100%;
            border-radius: 3px;
        }
        
        .health-bar .stat-bar-fill {
            background-color: var(--success-color);
        }
        
        .hunger-bar .stat-bar-fill {
            background-color: var(--carnivore-color);
        }
        
        .thirst-bar .stat-bar-fill {
            background-color: var(--highlight-color);
        }
        
        .stamina-bar .stat-bar-fill {
            background-color: var(--warning-color);
        }
        
        .stat-label {
            font-size: 10px;
            display: flex;
            justify-content: space-between;
            color: #aaa;
        }

        .map-container {
            flex: 1;
            position: relative;
            overflow: hidden;
            cursor: move;
        }

        .map-wrapper {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            transform-origin: center center;
        }

        .map-image {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 620px;
            height: 620px;
            max-width: none;
            object-fit: cover;
            pointer-events: none;
            user-select: none;
        }

        #markers-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 620px;
            height: 620px;
            pointer-events: none;
        }

        .player-marker {
            position: absolute;
            width: 5px;
            height: 5px;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 0 8px rgba(0, 0, 0, 0.5);
            z-index: 10;
            transition: all 0.3s ease;
            pointer-events: auto;
        }

        .player-marker:hover {
            transform: translate(-50%, -50%) scale(1.3);
            z-index: 20;
        }

        .marker-carnivore {
            background-color: var(--carnivore-color);
        }

        .marker-herbivore {
            background-color: var(--herbivore-color);
        }

        .marker-other {
            background-color: var(--other-color);
        }

        .marker-self {
            border: 3px solid yellow;
            box-shadow: 0 0 12px rgba(255, 255, 0, 0.7);
        }
        
        .marker-friend {
            border: 3px solid var(--friend-color);
            box-shadow: 0 0 12px rgba(156, 39, 176, 0.7);
        }

        .tooltip {
            position: absolute;
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 10px;
            border-radius: 4px;
            font-size: 12px;
            z-index: 100;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            max-width: 200px;
        }

        .tooltip-title {
            font-weight: bold;
            margin-bottom: 3px;
            display: flex;
            align-items: center;
        }
        
        .tooltip-title .friend-icon {
            margin-left: 5px;
        }
        
        .tooltip-stats {
            margin-top: 5px;
            display: none;
        }
        
        .tooltip-stats.visible {
            display: block;
        }
        
        .tooltip .stat-bar {
            height: 5px;
            margin-bottom: 3px;
        }
        
        .tooltip .stat-label {
            margin-bottom: 2px;
        }

        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }

        .toast {
            padding: 15px 20px;
            margin-bottom: 10px;
            border-radius: 5px;
            color: white;
            display: flex;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            animation: slideIn 0.3s, slideOut 0.3s 5s forwards;
            max-width: 300px;
        }

        .toast i {
            margin-right: 10px;
            font-size: 18px;
        }

        .toast.success {
            background-color: var(--success-color);
        }

        .toast.error {
            background-color: var(--error-color);
        }

        .toast.info {
            background-color: var(--highlight-color);
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        .nav-links {
            display: flex;
            gap: 15px;
        }

        .nav-links a {
            color: var(--text-color);
            text-decoration: none;
            padding: 8px 15px;
            border-radius: 4px;
            transition: background-color 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .nav-links a:hover, .nav-links a.active {
            background-color: var(--accent-color);
        }

        .map-controls {
            position: absolute;
            bottom: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .map-control-btn {
            width: 40px;
            height: 40px;
            background-color: rgba(0, 0, 0, 0.7);
            border: 1px solid var(--border-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .map-control-btn:hover {
            background-color: rgba(0, 0, 0, 0.9);
        }

        .players-count {
            position: absolute;
            top: 20px;
            left: 20px;
            background-color: rgba(0, 0, 0, 0.7);
            padding: 10px 15px;
            border-radius: 5px;
            font-size: 14px;
            z-index: 50;
        }

        .players-count i {
            margin-right: 8px;
            color: var(--accent-color);
        }

        @media screen and (max-width: 768px) {
            .content {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                border-right: none;
                border-bottom: 1px solid var(--border-color);
                max-height: 300px;
            }
        }

        .player-self {
            border-left-color: yellow;
        }

        #no-players-message {
            text-align: center;
            padding: 20px;
            color: #aaa;
        }
        
        .friend-dialog {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: var(--primary-color);
            border-radius: 5px;
            padding: 20px;
            z-index: 1000;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            width: 400px;
            display: none;
        }
        
        .friend-dialog h3 {
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 18px;
            display: flex;
            align-items: center;
        }
        
        .friend-dialog h3 i {
            margin-right: 8px;
            color: var(--friend-color);
        }
        
        .friend-dialog-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 999;
            display: none;
        }
        
        .friend-dialog-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
        }
        
        .friend-dialog-buttons button {
            flex: 1;
            margin: 0 5px;
        }
        
        .player-list-dialog {
            max-height: 200px;
            overflow-y: auto;
            margin-top: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 5px;
        }

        button {
            background-color: var(--accent-color);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        button i {
            margin-right: 8px;
        }

        button:hover {
            background-color: var(--accent-color-dark);
        }

        button:disabled {
            background-color: #666;
            cursor: not-allowed;
        }

        .avatar {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            margin-right: 10px;
        }

        .admin-badge {
            background-color: var(--error-color);
            color: white;
            padding: 2px 5px;
            border-radius: 3px;
            font-size: 10px;
            margin-left: 5px;
        }
    </style>
</head>
<body>
<div class="navbar">
    <h1><i class="fa-solid fa-dragon"></i> Jursk√Ω Masakr - Mapa</h1>
    <div class="nav-links">
        <a href="/" class="active"><i class="fa-solid fa-map"></i> Mapa</a>
        <a href="/stats"><i class="fa-solid fa-chart-bar"></i> Statistiky</a>
        <a href="/wiki.html"><i class="fa-solid fa-book"></i> Wiki</a>
        <a href="https://discord.gg/8MdXzVNBMY"><i class="fa-brands fa-discord"></i> Discord</a>

    </div>
</div>

    <div class="content">
        <div class="sidebar">
            <div class="auth-panel" id="auth-panel">
                <h3><i class="fa-solid fa-user"></i> P≈ôihl√°≈°en√≠</h3>
                <p>Pro zobrazen√≠ sv√© pozice na mapƒõ se p≈ôihlaste pomoc√≠ sv√©ho Steam √∫ƒçtu.</p>
                <div class="auth-panel-actions">
                    <a href="/auth/steam" class="login-button">
                        <button><i class="fa-brands fa-steam"></i> P≈ôihl√°sit p≈ôes Steam</button>
                    </a>
                </div>
                <div class="user-info" id="user-info">
                    <p>P≈ôihl√°≈°en jako <span id="user-name">U≈æivatel</span> <span id="admin-badge" class="admin-badge">Admin</span></p>
                    <button id="logout-btn"><i class="fa-solid fa-sign-out-alt"></i> Odhl√°sit</button>
                </div>
            </div>
            
            <div class="friends-panel" id="friends-panel">
                <h3>
                    <i class="fa-solid fa-user-friends"></i> Moji p≈ô√°tel√©
                    <span id="friend-requests-badge" class="notification-badge" style="display: none;" title="P≈ô√≠choz√≠ ≈æ√°dosti o p≈ô√°telstv√≠">0</span>
                    <span id="outgoing-requests-badge" class="notification-badge" style="display: none; background-color: #2196F3;" title="Odeslan√© ≈æ√°dosti">0</span>
                </h3>
                <div class="friends-list" id="friends-list">
                    <div id="no-friends-message" style="text-align: center; color: #aaa; padding: 10px;">
                        Zat√≠m nem√°te ≈æ√°dn√© p≈ô√°tele
                    </div>
                </div>
                <div class="add-friend-form">
                    <button class="add-friend-btn" id="add-friend-btn">
                        <i class="fa-solid fa-user-plus"></i> P≈ôidat p≈ô√≠tele
                    </button>
                </div>
            </div>

            <div class="filter-panel">
                <h3><i class="fa-solid fa-filter"></i> Filtry</h3>
                <div class="checkbox-group">
                    <label class="checkbox-label">
                        <input type="checkbox" class="dino-filter" value="carnivore" checked>
                        Maso≈æravci
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" class="dino-filter" value="herbivore" checked>
                        B√Ωlo≈æravci
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" class="dino-filter" value="other" checked>
                        V≈°e≈æravci
                    </label>
                </div>
                <div class="form-group">
                    <label for="search-player">Hledat hr√°ƒçe</label>
                    <input type="text" id="search-player" placeholder="Jm√©no hr√°ƒçe...">
                </div>
            </div>

            <div class="player-list">
                <h3><i class="fa-solid fa-users"></i> Hr√°ƒçi <span id="player-count">(0)</span></h3>
                <div id="players-container">
                    <div class="loading-text" id="player-loading">Naƒç√≠t√°n√≠ hr√°ƒç≈Ø...</div>
                    <div id="no-players-message">≈Ω√°dn√≠ hr√°ƒçi online</div>
                </div>
            </div>

            <div class="dino-stats">
                <h3><i class="fa-solid fa-paw"></i> Dinosau≈ôi</h3>
                <div id="dino-stats-container">
                    <div style="text-align: center; color: #aaa; padding: 10px;">
                        Naƒç√≠t√°n√≠ statistik...
                    </div>
                </div>
            </div>
        </div>
        
        <div class="map-container" id="map-container">
            <div class="map-wrapper" id="map-wrapper">
                <img src="/worldmap.png" alt="Mapa The Isle" class="map-image" id="map-image">
                <div id="markers-container"></div>
            </div>
            <div id="tooltip" class="tooltip"></div>
            
            <div class="players-count" id="players-count">
                <i class="fa-solid fa-users"></i>
                <span id="online-count">0</span> hr√°ƒç≈Ø online
            </div>
        </div>
        
        <div class="map-controls">
            <div class="map-control-btn" id="zoom-in"><i class="fa-solid fa-plus"></i></div>
            <div class="map-control-btn" id="zoom-out"><i class="fa-solid fa-minus"></i></div>
            <div class="map-control-btn" id="reset-view"><i class="fa-solid fa-home"></i></div>
        </div>
    </div>
    
    <div class="friend-dialog-overlay" id="friend-dialog-overlay"></div>
    <div class="friend-dialog" id="friend-dialog">
        <h3><i class="fa-solid fa-user-plus"></i> P≈ôidat p≈ô√≠tele</h3>
        <p>Vyberte hr√°ƒçe, kter√© chcete p≈ôidat mezi p≈ô√°tele:</p>
        
        <div class="friend-permission-options">
            <h4 style="margin: 0 0 10px 0; font-size: 14px;">Sd√≠len√≠ informac√≠:</h4>
            <label class="permission-checkbox">
                <input type="checkbox" id="share-location" checked>
                Sd√≠let moji pozici na mapƒõ
            </label>
            <label class="permission-checkbox">
                <input type="checkbox" id="share-stats">
                Sd√≠let moje statistiky (zdrav√≠, hlad, ≈æ√≠ze≈à)
            </label>
        </div>
        
        <div class="player-list-dialog" id="player-list-dialog">
        </div>
        <div class="friend-dialog-buttons">
            <button id="friend-dialog-cancel"><i class="fa-solid fa-times"></i> Zru≈°it</button>
            <button id="friend-dialog-add" class="add-friend-btn"><i class="fa-solid fa-user-plus"></i> Odeslat ≈æ√°dosti</button>
        </div>
    </div>

    <!-- Cache indik√°tor (p≈ôid√°n dynamicky JS) -->
    <div id="cache-indicator" class="cache-indicator" style="display: none;"></div>

    <div class="toast-container" id="toast-container"></div>

    <script>
// Glob√°ln√≠ promƒõnn√© pro mapov√°n√≠
let mapScale = 1;
let mapTranslateX = 0;
let mapTranslateY = 0;
let isDragging = false;
let lastMouseX = 0;
let lastMouseY = 0;
let playersData = [];
let filteredPlayersData = [];
let refreshTimerInterval;
let friendsManager;
let mapImageDimensions = { width: 0, height: 0 };

// API a p≈ôihl√°≈°en√≠
document.addEventListener('DOMContentLoaded', function() {
    // Konstanty a konfigurace
    const AUTO_REFRESH_INTERVAL = 60; // v sekund√°ch
    const API_URL = window.location.origin + '/api';
    
    // DOM elementy
    const markersContainer = document.getElementById('markers-container');
    const tooltip = document.getElementById('tooltip');
    const mapImage = document.getElementById('map-image');
    const mapContainer = document.getElementById('map-container');
    const mapWrapper = document.getElementById('map-wrapper');
    const refreshBtn = document.getElementById('refresh-btn');
    const lastUpdate = document.getElementById('last-update');
    const autoRefreshCheckbox = document.getElementById('auto-refresh');
    const refreshTimer = document.getElementById('refresh-timer');
    const refreshLoader = document.getElementById('refresh-loader');
    const playerLoading = document.getElementById('player-loading');
    const noPlayersMessage = document.getElementById('no-players-message');
    const searchPlayer = document.getElementById('search-player');
    const toastContainer = document.getElementById('toast-container');
    const logoutBtn = document.getElementById('logout-btn');
    const userArea = document.getElementById('user-area');
    const authPanel = document.getElementById('auth-panel');
    const userInfo = document.getElementById('user-info');
    const userName = document.getElementById('user-name');
    const adminBadge = document.getElementById('admin-badge');
    const playersContainer = document.getElementById('players-container');
    const friendsPanel = document.getElementById('friends-panel');
    const friendsList = document.getElementById('friends-list');
    const addFriendBtn = document.getElementById('add-friend-btn');
    const friendDialog = document.getElementById('friend-dialog');
    const friendDialogOverlay = document.getElementById('friend-dialog-overlay');
    const friendDialogCancel = document.getElementById('friend-dialog-cancel');
    const friendDialogAdd = document.getElementById('friend-dialog-add');
    const playerListDialog = document.getElementById('player-list-dialog');
    const playerCount = document.getElementById('player-count');
    const onlineCount = document.getElementById('online-count');
    const dinoStatsContainer = document.getElementById('dino-stats-container');

    // Inicializace rozmƒõr≈Ø mapy pro Gateway 620x620 - FIXN√ç rozmƒõry
    function updateMapDimensions() {
        // Mapa m√° v≈ædy fixn√≠ rozmƒõry 620x620px
        mapImageDimensions.width = 620;
        mapImageDimensions.height = 620;
        
        // Kontejner marker≈Ø m√° stejn√© rozmƒõry jako mapa
        if (markersContainer) {
            markersContainer.style.width = '620px';
            markersContainer.style.height = '620px';
            // Um√≠stit kontejner marker≈Ø p≈ôesnƒõ na mapu
            markersContainer.style.top = '50%';
            markersContainer.style.left = '50%';
            markersContainer.style.transform = 'translate(-50%, -50%)';
        }
        
        console.log('Gateway mapa - fixn√≠ rozmƒõry 620x620px, hranice ¬±400k');
    }

    // Funkce pro p≈ôepoƒçet r≈Østu
    function calculateDisplayGrowth(actualGrowth) {
        // P≈ôepoƒçet z hern√≠ hodnoty na procenta
        // 100% = 0.75, tak≈æe vzorec je: display = (actual / 0.75) * 100
        if (!actualGrowth) return 0;
        return Math.round((actualGrowth / 0.750) * 100);
    }

    // NOV√ù FriendsManager s API podporou a friend requests
    class FriendsManager {
        constructor() {
            this.friends = [];
            this.incomingRequests = [];
            this.outgoingRequests = [];
            this.friendsPanel = document.getElementById('friends-panel');
            this.friendsList = document.getElementById('friends-list');
            this.noFriendsMessage = document.getElementById('no-friends-message');
            this.addFriendBtn = document.getElementById('add-friend-btn');
            this.friendDialog = document.getElementById('friend-dialog');
            this.friendDialogOverlay = document.getElementById('friend-dialog-overlay');
            this.playerListDialog = document.getElementById('player-list-dialog');
            
            this.init();
        }
        
        async init() {
            this.setupEventListeners();
            await this.loadFriendsFromAPI();
            this.updateFriendsList();
            
            // Periodick√° aktualizace ≈æ√°dost√≠ ka≈ædou minutu
            setInterval(() => {
                this.loadFriendsFromAPI();
            }, 60000);
        }
        
        setupEventListeners() {
            if (this.addFriendBtn) {
                this.addFriendBtn.addEventListener('click', () => {
                    this.showAddFriendDialog();
                });
            }
            
            const cancelBtn = document.getElementById('friend-dialog-cancel');
            const addBtn = document.getElementById('friend-dialog-add');
            
            if (cancelBtn) {
                cancelBtn.addEventListener('click', () => {
                    this.hideAddFriendDialog();
                });
            }
            
            if (addBtn) {
                addBtn.addEventListener('click', () => {
                    this.addSelectedFriends();
                });
            }
            
            if (this.friendDialogOverlay) {
                this.friendDialogOverlay.addEventListener('click', () => {
                    this.hideAddFriendDialog();
                });
            }
        }
        
        // Naƒçten√≠ p≈ô√°tel z API m√≠sto localStorage
        async loadFriendsFromAPI() {
            if (!window.user) {
                console.log('U≈æivatel nen√≠ p≈ôihl√°≈°en, p≈ôeskakuji naƒçten√≠ p≈ô√°tel');
                return;
            }
            
            // Zabr√°nit duplicitn√≠mu vol√°n√≠
            if (this._isLoading) {
                console.log('LoadFriendsFromAPI ji≈æ prob√≠h√°, p≈ôeskakuji...');
                return;
            }
            
            this._isLoading = true;
            
            try {
                console.log('Naƒç√≠t√°m p≈ô√°tele z API...');
                
                const response = await fetch('/api/friends/friends', {
                    method: 'GET',
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        this.friends = data.friends || [];
                        this.incomingRequests = data.incomingRequests || [];
                        this.outgoingRequests = data.outgoingRequests || [];
                        
                        console.log(`‚úÖ API naƒçteno: ${this.friends.length} p≈ô√°tel, ${this.incomingRequests.length} p≈ô√≠choz√≠ch, ${this.outgoingRequests.length} odchoz√≠ch ≈æ√°dost√≠`);
                        
                        // Zobrazit notifikaci o ƒçekaj√≠c√≠ch ≈æ√°dostech
                        if (this.incomingRequests.length > 0) {
                            this.showPendingRequestsNotification();
                        }
                        
                        this.updateFriendRequestsBadge();
                        this.updateFriendsList();
                    } else {
                        console.warn('‚ö†Ô∏è Chyba p≈ôi naƒç√≠t√°n√≠ p≈ô√°tel z API:', data.error);
                    }
                } else {
                    console.warn('‚ö†Ô∏è API nedostupn√©');
                }
            } catch (error) {
                console.error('‚ùå Chyba p≈ôi komunikaci s API p≈ô√°tel:', error);
            } finally {
                this._isLoading = false;
            }
        }
        
        // ≈Ω√°dost o p≈ô√°telstv√≠ p≈ôes API
        async addFriend(steamId, name, shareLocation = true, shareStats = false) {
            if (!steamId || !name) return false;
            
            if (!window.user) {
                showToast('Mus√≠te b√Ωt p≈ôihl√°≈°eni pro p≈ôid√°n√≠ p≈ô√°tel', 'error');
                return false;
            }
            
            // Kontrola, zda u≈æ nen√≠ p≈ô√≠telem
            if (this.isFriend(steamId)) {
                showToast(`${name} je ji≈æ v seznamu p≈ô√°tel`, 'info');
                return false;
            }
            
            // Kontrola, zda u≈æ nem√° pending request
            if (this.hasPendingRequest(steamId)) {
                showToast(`≈Ω√°dost hr√°ƒçi ${name} ji≈æ byla odesl√°na`, 'info');
                return false;
            }
            
            // Kontrola, zda to nen√≠ vlastn√≠ √∫ƒçet
            if (steamId === window.user.id) {
                showToast('Nem≈Ø≈æete p≈ôidat sebe jako p≈ô√≠tele', 'error');
                return false;
            }
            
            try {
                console.log(`Odes√≠l√°m ≈æ√°dost o p≈ô√°telstv√≠: ${name} (${steamId})`);
                
                const response = await fetch('/api/friends/request', {
                    method: 'POST',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        friendId: steamId,
                        shareLocation: shareLocation,
                        shareStats: shareStats
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showToast(`≈Ω√°dost o p≈ô√°telstv√≠ odesl√°na hr√°ƒçi ${name}`, 'success');
                    
                    // POUZE refresh z API
                    await this.loadFriendsFromAPI();
                    
                    // Aktualizovat seznam hr√°ƒç≈Ø aby se hr√°ƒç u≈æ nezobrazoval jako dostupn√Ω
                    if (typeof updatePlayersList === 'function') {
                        updatePlayersList();
                    }
                    
                    console.log('≈Ω√°dost √∫spƒõ≈°nƒõ odesl√°na a data refreshnuta');
                    return true;
                } else {
                    console.error('API chyba:', data.error);
                    showToast(data.error || 'Chyba p≈ôi odes√≠l√°n√≠ ≈æ√°dosti', 'error');
                    return false;
                }
            } catch (error) {
                console.error('S√≠≈•ov√° chyba p≈ôi odes√≠l√°n√≠ ≈æ√°dosti:', error);
                showToast('Chyba p≈ôi odes√≠l√°n√≠ ≈æ√°dosti', 'error');
                return false;
            }
        }
        
        // P≈ôijet√≠ ≈æ√°dosti o p≈ô√°telstv√≠
        async acceptFriendRequest(requestId, shareLocation = true, shareStats = false) {
            try {
                const response = await fetch('/api/friends/accept', {
                    method: 'POST',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        requestId: requestId,
                        shareLocation: shareLocation,
                        shareStats: shareStats
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showToast('≈Ω√°dost o p≈ô√°telstv√≠ p≈ôijata', 'success');
                    await this.loadFriendsFromAPI();
                    return true;
                } else {
                    showToast(data.error || 'Chyba p≈ôi p≈ôij√≠m√°n√≠ ≈æ√°dosti', 'error');
                    return false;
                }
            } catch (error) {
                console.error('Chyba p≈ôi p≈ôij√≠m√°n√≠ ≈æ√°dosti:', error);
                showToast('Chyba p≈ôi p≈ôij√≠m√°n√≠ ≈æ√°dosti', 'error');
                return false;
            }
        }
        
        // Zru≈°en√≠ odchoz√≠ ≈æ√°dosti o p≈ô√°telstv√≠
        async cancelFriendRequest(steamId, name) {
            // Potvrzovac√≠ dialog
            if (!confirm(`Opravdu chcete zru≈°it ≈æ√°dost o p≈ô√°telstv√≠ pro hr√°ƒçe ${name}?`)) {
                return false;
            }
            
            try {
                console.log(`Ru≈°√≠m ≈æ√°dost pro: ${name} (${steamId})`);
                
                const response = await fetch('/api/friends/cancel', {
                    method: 'POST',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        friendId: steamId
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showToast(`≈Ω√°dost pro ${name} byla zru≈°ena`, 'info');
                    await this.loadFriendsFromAPI();
                    
                    // Aktualizovat seznam hr√°ƒç≈Ø aby se hr√°ƒç zase zobrazoval jako dostupn√Ω
                    if (typeof updatePlayersList === 'function') {
                        updatePlayersList();
                    }
                    
                    return true;
                } else {
                    showToast(data.error || 'Chyba p≈ôi ru≈°en√≠ ≈æ√°dosti', 'error');
                    return false;
                }
            } catch (error) {
                console.error('Chyba p≈ôi ru≈°en√≠ ≈æ√°dosti:', error);
                showToast('Chyba p≈ôi ru≈°en√≠ ≈æ√°dosti', 'error');
                return false;
            }
        }
        
        async rejectFriendRequest(requestId) {
            try {
                const response = await fetch('/api/friends/reject', {
                    method: 'POST',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        requestId: requestId
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showToast('≈Ω√°dost odm√≠tnuta', 'info');
                    await this.loadFriendsFromAPI();
                    return true;
                } else {
                    showToast(data.error || 'Chyba p≈ôi odm√≠t√°n√≠ ≈æ√°dosti', 'error');
                    return false;
                }
            } catch (error) {
                console.error('Chyba p≈ôi odm√≠t√°n√≠ ≈æ√°dosti:', error);
                showToast('Chyba p≈ôi odm√≠t√°n√≠ ≈æ√°dosti', 'error');
                return false;
            }
        }
        
        // Odstranƒõn√≠ p≈ô√≠tele p≈ôes API
        async removeFriend(steamId) {
            const friend = this.getFriend(steamId);
            if (!friend) return false;
            
            try {
                const response = await fetch(`/api/friends/${steamId}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showToast(`P≈ô√≠tel ${friend.friend_name || friend.name || 'nezn√°m√Ω'} byl odebr√°n`, 'info');
                    await this.loadFriendsFromAPI();
                    return true;
                } else {
                    showToast(data.error || 'Chyba p≈ôi odeb√≠r√°n√≠ p≈ô√≠tele', 'error');
                    return false;
                }
            } catch (error) {
                console.error('Chyba p≈ôi odeb√≠r√°n√≠ p≈ô√≠tele:', error);
                showToast('Chyba p≈ôi odeb√≠r√°n√≠ p≈ô√≠tele', 'error');
                return false;
            }
        }
        
        isFriend(steamId) {
            return this.friends.some(f => (f.friend_steam_id || f.steamId) === steamId);
        }
        
        getFriend(steamId) {
            return this.friends.find(f => (f.friend_steam_id || f.steamId) === steamId);
        }
        
        // NOV√Å metoda - kontrola pending request≈Ø
        hasPendingRequest(steamId) {
            return this.outgoingRequests.some(req => 
                req.friend_id === steamId || 
                req.steamId === steamId ||
                req.friend_steam_id === steamId
            );
        }
        
        // Zobrazuje i friend requests
        updateFriendsList() {
            if (!this.friendsList) return;
            
            if (!window.user) {
                if (this.friendsPanel) {
                    this.friendsPanel.style.display = 'none';
                }
                return;
            } else {
                if (this.friendsPanel) {
                    this.friendsPanel.style.display = 'block';
                }
            }
            
            console.log('üîÑ Aktualizuji seznam p≈ô√°tel...');
            console.log(`  - ${this.friends.length} p≈ô√°tel`);
            console.log(`  - ${this.incomingRequests.length} p≈ô√≠choz√≠ch ≈æ√°dost√≠`);
            console.log(`  - ${this.outgoingRequests.length} odchoz√≠ch ≈æ√°dost√≠`);
            
            let contentHTML = '';
            
            // P≈ô√≠choz√≠ ≈æ√°dosti o p≈ô√°telstv√≠
            if (this.incomingRequests.length > 0) {
                console.log('üì• Zobrazuji p≈ô√≠choz√≠ ≈æ√°dosti:', this.incomingRequests);
                
                contentHTML += `
                    <div style="margin-bottom: 15px; padding: 10px; background-color: rgba(255, 193, 7, 0.1); border-left: 3px solid #ffc107; border-radius: 0 4px 4px 0;">
                        <h4 style="margin: 0 0 10px 0; color: #ffc107; font-size: 14px;">
                            <i class="fa-solid fa-user-clock"></i> ≈Ω√°dosti o p≈ô√°telstv√≠ (${this.incomingRequests.length})
                        </h4>
                `;
                
                this.incomingRequests.forEach(request => {
                    const requesterName = request.requester_name || `Hr√°ƒç ${request.requester_steam_id}`;
                    console.log(`  - ≈Ω√°dost od: ${requesterName} (ID: ${request.id})`);
                    
                    contentHTML += `
                        <div style="background-color: rgba(255, 255, 255, 0.05); padding: 8px; margin-bottom: 8px; border-radius: 4px;">
                            <div style="font-weight: bold; margin-bottom: 5px;">${requesterName}</div>
                            <div style="display: flex; gap: 5px;">
                                <button onclick="window.friendsManager.acceptFriendRequest(${request.id})" 
                                        style="flex: 1; padding: 4px 8px; background-color: #4CAF50; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 12px;"
                                        onkeydown="if(event.key==='Enter') this.click()">
                                    <i class="fa-solid fa-check"></i> P≈ôijmout
                                </button>
                                <button onclick="window.friendsManager.rejectFriendRequest(${request.id})" 
                                        style="flex: 1; padding: 4px 8px; background-color: #f44336; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 12px;"
                                        onkeydown="if(event.key==='Enter') this.click()">
                                    <i class="fa-solid fa-times"></i> Odm√≠tnout
                                </button>
                            </div>
                        </div>
                    `;
                });
                
                contentHTML += `</div>`;
            } else {
                console.log('üì• ≈Ω√°dn√© p≈ô√≠choz√≠ ≈æ√°dosti');
            }
            
            // Odchoz√≠ ≈æ√°dosti o p≈ô√°telstv√≠ (ƒçekaj√≠ na p≈ôijet√≠)
            if (this.outgoingRequests.length > 0) {
                console.log('üì§ Zobrazuji odchoz√≠ ≈æ√°dosti:', this.outgoingRequests);
                
                contentHTML += `
                    <div style="margin-bottom: 15px; padding: 10px; background-color: rgba(33, 150, 243, 0.1); border-left: 3px solid #2196F3; border-radius: 0 4px 4px 0;">
                        <h4 style="margin: 0 0 10px 0; color: #2196F3; font-size: 14px;">
                            <i class="fa-solid fa-clock"></i> Odeslan√© ≈æ√°dosti (${this.outgoingRequests.length})
                        </h4>
                `;
                
                this.outgoingRequests.forEach(request => {
                    const friendSteamId = request.friend_id || request.steamId;
                    const friendName = request.friend_name || request.name || `Hr√°ƒç ${friendSteamId}`;
                    
                    console.log(`  - ≈Ω√°dost pro: ${friendName} (ID: ${friendSteamId})`);
                    
                    contentHTML += `
                        <div style="background-color: rgba(255, 255, 255, 0.05); padding: 8px; margin-bottom: 8px; border-radius: 4px;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="font-weight: bold;">${friendName}</div>
                                    <div style="font-size: 12px; color: #888;">
                                        <i class="fa-solid fa-hourglass-half"></i> ƒåek√° na p≈ôijet√≠...
                                    </div>
                                </div>
                                <button onclick="window.friendsManager.cancelFriendRequest('${friendSteamId}', '${friendName.replace(/'/g, "\\'")}')" 
                                        class="friend-cancel-btn"
                                        title="Zru≈°it ≈æ√°dost"
                                        onkeydown="if(event.key==='Enter') this.click()">
                                    <i class="fa-solid fa-times"></i> Zru≈°it
                                </button>
                            </div>
                        </div>
                    `;
                });
                
                contentHTML += `</div>`;
            } else {
                console.log('üì§ ≈Ω√°dn√© odchoz√≠ ≈æ√°dosti');
            }
            
            // Souƒçasn√≠ p≈ô√°tel√©
            if (this.friends.length === 0 && this.incomingRequests.length === 0 && this.outgoingRequests.length === 0) {
                contentHTML += '<div style="text-align: center; color: #aaa; padding: 10px;">Zat√≠m nem√°te ≈æ√°dn√© p≈ô√°tele</div>';
            } else if (this.friends.length > 0) {
                console.log('üë• Zobrazuji p≈ô√°tele:', this.friends);
                
                const players = this.getCurrentPlayersData();
                
                this.friends.forEach(friend => {
                    const friendSteamId = friend.friend_steam_id || friend.steamId;
                    const friendName = friend.friend_name || friend.name || friendSteamId;
                    
                    const isOnline = players && players.some(p => p.steamId === friendSteamId);
                    const onlinePlayer = isOnline ? players.find(p => p.steamId === friendSteamId) : null;
                    
                    contentHTML += `
                        <div class="friend-item" data-steam-id="${friendSteamId}">
                            <div class="friend-name">
                                <span class="friend-online ${isOnline ? 'online' : 'offline'}"></span>
                                ${friendName}
                                ${onlinePlayer ? `<span style="color: #aaa; font-size: 11px; margin-left: 5px;">(${onlinePlayer.dino})</span>` : ''}
                            </div>
                            <div class="friend-remove" data-steam-id="${friendSteamId}" title="Odebrat p≈ô√≠tele">
                                <i class="fa-solid fa-times"></i>
                            </div>
                        </div>
                    `;
                });
            }
            
            console.log('üé® Nastavuji HTML obsah...');
            this.friendsList.innerHTML = contentHTML;
            
            // Event listenery pro p≈ô√°tele
            this.friendsList.querySelectorAll('.friend-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    if (e.target.closest('.friend-remove')) return;
                    
                    const steamId = item.getAttribute('data-steam-id');
                    this.centerOnFriend(steamId);
                });
            });
            
            this.friendsList.querySelectorAll('.friend-remove').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const steamId = btn.getAttribute('data-steam-id');
                    this.removeFriend(steamId);
                });
            });
            
            this.updateFriendRequestsBadge();
            console.log('‚úÖ Seznam p≈ô√°tel aktualizov√°n');
        }
        
        // Z√≠sk√°n√≠ aktu√°ln√≠ch dat hr√°ƒç≈Ø z r≈Øzn√Ωch zdroj≈Ø
        getCurrentPlayersData() {
            return window.players || window.playersData || playersData || 
                   (window.app && window.app.players) || [];
        }
        
        // Notifikace o ƒçekaj√≠c√≠ch ≈æ√°dostech
        showPendingRequestsNotification() {
            if (typeof showToast === 'function') {
                showToast(`M√°te ${this.incomingRequests.length} ƒçekaj√≠c√≠ch ≈æ√°dost√≠ o p≈ô√°telstv√≠`, 'info');
            }
        }
        
        // Aktualizace badge pro friend requests - pouze p≈ô√≠choz√≠ ≈æ√°dosti
        updateFriendRequestsBadge() {
            const incomingBadge = document.getElementById('friend-requests-badge');
            const outgoingBadge = document.getElementById('outgoing-requests-badge');
            
            // P≈ô√≠choz√≠ ≈æ√°dosti (ƒçerven√©)
            if (incomingBadge) {
                const incomingCount = this.incomingRequests.length;
                
                if (incomingCount > 0) {
                    incomingBadge.textContent = incomingCount;
                    incomingBadge.style.display = 'inline';
                } else {
                    incomingBadge.style.display = 'none';
                }
            }
            
            // Odchoz√≠ ≈æ√°dosti (modr√©)
            if (outgoingBadge) {
                const outgoingCount = this.outgoingRequests.length;
                
                if (outgoingCount > 0) {
                    outgoingBadge.textContent = outgoingCount;
                    outgoingBadge.style.display = 'inline';
                } else {
                    outgoingBadge.style.display = 'none';
                }
            }
        }
        
        centerOnFriend(steamId) {
            const players = this.getCurrentPlayersData();
            
            if (!players || !window.centerOnPlayer) return;
            
            const player = players.find(p => p.steamId === steamId);
            if (!player || !player.x || !player.y) {
                const friend = this.getFriend(steamId);
                const friendName = friend ? (friend.friend_name || friend.name || friend.friend_steam_id) : 'P≈ô√≠tel';
                if (typeof showToast === 'function') {
                    showToast(`${friendName} nen√≠ moment√°lnƒõ online`, 'info');
                }
                return;
            }
            
            window.centerOnPlayer(player);
            
            if (typeof highlightMarker === 'function') {
                highlightMarker(player);
                setTimeout(() => {
                    if (typeof unhighlightMarker === 'function') {
                        unhighlightMarker(player);
                    }
                }, 3000);
            }
        }
        
        showAddFriendDialog() {
            const players = this.getCurrentPlayersData();
            
            console.log('Debug - showAddFriendDialog players:', players);
            
            if (!players || players.length === 0) {
                if (typeof showToast === 'function') {
                    showToast('≈Ω√°dn√≠ hr√°ƒçi nejsou online', 'info');
                }
                return;
            }
            
            this.updatePlayerListDialog();
            
            if (this.friendDialog && this.friendDialogOverlay) {
                this.friendDialog.style.display = 'block';
                this.friendDialogOverlay.style.display = 'block';
            }
        }
        
        hideAddFriendDialog() {
            if (this.friendDialog && this.friendDialogOverlay) {
                this.friendDialog.style.display = 'none';
                this.friendDialogOverlay.style.display = 'none';
            }
            
            this.playerListDialog.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                cb.checked = false;
            });
        }
        
        updatePlayerListDialog() {
            if (!this.playerListDialog) return;
            
            const players = this.getCurrentPlayersData();
            
            console.log('Debug - updatePlayerListDialog players:', players);
            
            let playersHTML = '';
            
            const availablePlayers = players.filter(player => {
                const hasValidData = player.steamId && player.name;
                const notSelf = !window.user || player.steamId !== window.user.id;
                const notAlreadyFriend = !this.isFriend(player.steamId);
                const noPendingRequest = !this.hasPendingRequest(player.steamId); // OPRAVENO - kontrola pending request≈Ø
                
                return hasValidData && notSelf && notAlreadyFriend && noPendingRequest;
            });
            
            console.log('Debug - availablePlayers:', availablePlayers);
            
            if (availablePlayers.length === 0) {
                playersHTML = '<div style="text-align: center; color: #aaa; padding: 10px;">≈Ω√°dn√≠ dostupn√≠ hr√°ƒçi pro p≈ôid√°n√≠</div>';
            } else {
                availablePlayers.forEach(player => {
                    playersHTML += `
                        <label style="display: block; padding: 8px; cursor: pointer; border-bottom: 1px solid #333;">
                            <input type="checkbox" value="${player.steamId}" data-name="${player.name}" style="margin-right: 8px;">
                            ${player.name}
                        </label>
                    `;
                });
            }
            
            this.playerListDialog.innerHTML = playersHTML;
        }
        
        async addSelectedFriends() {
            if (!this.playerListDialog) return;
            
            // Zabr√°nit dvojit√©mu kliknut√≠
            const addButton = document.getElementById('friend-dialog-add');
            if (addButton && addButton.disabled) {
                return;
            }
            
            if (addButton) {
                addButton.disabled = true;
                addButton.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Odes√≠l√°m...';
            }
            
            const checkboxes = this.playerListDialog.querySelectorAll('input[type="checkbox"]:checked');
            let addedCount = 0;
            
            const shareLocationCheckbox = document.getElementById('share-location');
            const shareStatsCheckbox = document.getElementById('share-stats');
            
            const shareLocation = shareLocationCheckbox ? shareLocationCheckbox.checked : true;
            const shareStats = shareStatsCheckbox ? shareStatsCheckbox.checked : false;
            
            console.log(`Zaƒç√≠n√°m odes√≠lat ${checkboxes.length} ≈æ√°dost√≠...`);
            
            for (const checkbox of checkboxes) {
                const steamId = checkbox.value;
                const name = checkbox.getAttribute('data-name');
                
                console.log(`Odes√≠l√°m ≈æ√°dost pro: ${name} (${steamId})`);
                
                if (await this.addFriend(steamId, name, shareLocation, shareStats)) {
                    addedCount++;
                    console.log(`√öspƒõ≈°nƒõ odesl√°no pro: ${name}`);
                } else {
                    console.log(`Selhalo pro: ${name}`);
                }
            }
            
            if (addedCount > 0) {
                if (typeof showToast === 'function') {
                    showToast(`Odesl√°no ${addedCount} ≈æ√°dost√≠ o p≈ô√°telstv√≠`, 'success');
                }
            }
            
            // Obnovit tlaƒç√≠tko
            if (addButton) {
                addButton.disabled = false;
                addButton.innerHTML = '<i class="fa-solid fa-user-plus"></i> Odeslat ≈æ√°dosti';
            }
            
            this.hideAddFriendDialog();
        }
        
        // Metody pro kompatibilitu s p≈Øvodn√≠m k√≥dem
        updateFriendsDisplay() {
            this.updateFriendsList();
        }
        
        async loadPendingRequests() {
            return this.incomingRequests;
        }
    }

    // Inicializace rozmƒõr≈Ø mapy s fixn√≠mi rozmƒõry
    function initializeMap() {
        updateMapDimensions();
        
        const containerRect = mapContainer.getBoundingClientRect();
        const containerWidth = containerRect.width;
        const containerHeight = containerRect.height;
        
        const scaleX = containerWidth / 620;
        const scaleY = containerHeight / 620;
        mapScale = Math.min(scaleX, scaleY, 1);
        
        mapTranslateX = 0;
        mapTranslateY = 0;
        updateMapTransform();
    }

    // Aktualizace transformace mapy
    function updateMapTransform() {
        if (mapWrapper) {
            mapWrapper.style.transform = `translate(${mapTranslateX}px, ${mapTranslateY}px) scale(${mapScale})`;
        }
    }

    // GATEWAY MAPA - P≈ôesn√° kalibrace podle islemaps.com
    function positionMarker(marker, gameX, gameY) {
        if (!marker || gameX === undefined || gameY === undefined) {
            console.warn('Neplatn√© parametry pro positionMarker', { marker, gameX, gameY });
            return;
        }
        
        try {
            // Gateway mapa hranice - p≈ôesn√° kalibrace
            const MAP_BOUNDS = {
                minLat: -700000,  // Z√°padn√≠ hranice 
                maxLat: 720000,   // V√Ωchodn√≠ hranice 
                minLong: -720000, // Severn√≠ hranice 
                maxLong: 700000   // Ji≈æn√≠ hranice 
            };
            
            // Fixn√≠ rozmƒõr mapy
            const MAP_SIZE = 620;
            
            // Mapov√°n√≠ sou≈ôadnic na pozici v pixelech (0-620)
            function mapCoordinateToPixel(value, min, max, mapSize) {
                const normalized = (value - min) / (max - min);
                const clamped = Math.max(0, Math.min(1, normalized));
                return clamped * mapSize;
            }
            
            // P≈ôev√©st hern√≠ sou≈ôadnice p≈ô√≠mo na pixely v rozmez√≠ 0-620
            const pixelX = mapCoordinateToPixel(gameX, MAP_BOUNDS.minLat, MAP_BOUNDS.maxLat, MAP_SIZE);
            const pixelY = mapCoordinateToPixel(gameY, MAP_BOUNDS.minLong, MAP_BOUNDS.maxLong, MAP_SIZE);
            
            // Um√≠stit marker p≈ô√≠mo na tyto sou≈ôadnice
            marker.style.left = `${pixelX}px`;
            marker.style.top = `${pixelY}px`;
            
            console.debug(`Gateway kalibrace - Game(${gameX}, ${gameY}) -> Pixel(${pixelX.toFixed(2)}, ${pixelY.toFixed(2)})`);
            
        } catch (error) {
            console.error('Chyba p≈ôi pozicov√°n√≠ markeru:', error);
        }
    }

    // Vymaz√°n√≠ v≈°ech marker≈Ø
    function clearMarkers() {
        if (markersContainer) {
            markersContainer.innerHTML = '';
        }
    }

    // P≈ôid√°n√≠ markeru hr√°ƒçe
    function addPlayerMarker(player) {
        if (!markersContainer || !player.x || !player.y) return;

        const marker = document.createElement('div');
        marker.className = 'player-marker';
        marker.dataset.playerId = player.steamId || player.name;
        
        // Urƒçen√≠ typu dinosaura
        const dinoType = getDinosaurType(player.dino);
        marker.classList.add(`marker-${dinoType}`);
        
        // Oznaƒçen√≠ vlastn√≠ho hr√°ƒçe
        if (window.user && player.steamId === window.user.id) {
            marker.classList.add('marker-self');
        }
        
        // Oznaƒçen√≠ p≈ô√≠tele
        if (player.steamId && friendsManager && friendsManager.isFriend(player.steamId)) {
            marker.classList.add('marker-friend');
        }
        
        // Pozicov√°n√≠ markeru s opravenou kalibrac√≠
        positionMarker(marker, player.x, player.y);
        
        // Event listenery
        marker.addEventListener('mouseenter', (e) => showPlayerTooltip(player, e));
        marker.addEventListener('mousemove', positionTooltip);
        marker.addEventListener('mouseleave', hideTooltip);
        marker.addEventListener('click', () => centerOnPlayer(player));
        
        markersContainer.appendChild(marker);
        return marker;
    }

    // Urƒçen√≠ typu dinosaura
    function getDinosaurType(dinoName) {
        const carnivores = [
            'Carnotaurus', 'Allosaurus', 'Ceratosaurus', 'Dilophosaurus', 
            'Omniraptor', 'Albertosaurus', 'Deinosuchus', 'Tyrannosaurus',
            'Herrerasaurus', 'Compsognathus', 'Megalosaurus', 'Deinonychus'
        ];
        
        const herbivores = [
            'Triceratops', 'Stegosaurus', 'Parasaurolophus', 'Maiasaura',
            'Camarasaurus', 'Therizinosaurus', 'Gallimimus', 'Dryosaurus',
            'Pachycephalosaurus', 'Baryonyx', 'Kentrosaurus', 'Diabloceratops'
        ];
        
        if (carnivores.some(name => dinoName.includes(name))) {
            return 'carnivore';
        } else if (herbivores.some(name => dinoName.includes(name))) {
            return 'herbivore';
        } else {
            return 'other';
        }
    }

    // Zv√Ωraznƒõn√≠ markeru
    function highlightMarker(player) {
        document.querySelectorAll('.player-marker').forEach(marker => {
            marker.style.boxShadow = '';
        });
        
        const marker = document.querySelector(`[data-player-id="${player.steamId || player.name}"]`);
        if (marker) {
            marker.style.boxShadow = '0 0 20px 5px rgba(255, 255, 0, 0.8)';
            
            setTimeout(() => {
                marker.style.boxShadow = '';
            }, 3000);
        }
    }

    // Zru≈°en√≠ zv√Ωraznƒõn√≠ markeru
    function unhighlightMarker(player) {
        const marker = document.querySelector(`[data-player-id="${player.steamId || player.name}"]`);
        if (marker) {
            marker.style.boxShadow = '';
        }
    }

    // OPRAVEN√â centrov√°n√≠ na hr√°ƒçe s nov√Ωmi hranicemi
    function centerOnPlayer(player) {
        if (!player.x || !player.y) return;
        
        // Stejn√© hranice jako v positionMarker
        const MAP_BOUNDS = {
            minLat: -690000,
            maxLat: 865000,
            minLong: -725000,
            maxLong: 690000
        };
        
        const MAP_SIZE = 620;
        
        function mapCoordinateToPixel(value, min, max, mapSize) {
            const normalized = (value - min) / (max - min);
            const clamped = Math.max(0, Math.min(1, normalized));
            return clamped * mapSize;
        }
        
        const pixelX = mapCoordinateToPixel(player.x, MAP_BOUNDS.minLat, MAP_BOUNDS.maxLat, MAP_SIZE);
        const pixelY = mapCoordinateToPixel(player.y, MAP_BOUNDS.minLong, MAP_BOUNDS.maxLong, MAP_SIZE);
        
        const containerRect = mapContainer.getBoundingClientRect();
        const centerX = containerRect.width / 2;
        const centerY = containerRect.height / 2;
        
        const scaledPlayerX = (pixelX - MAP_SIZE/2) * mapScale;
        const scaledPlayerY = (pixelY - MAP_SIZE/2) * mapScale;
        
        mapTranslateX = -scaledPlayerX;
        mapTranslateY = -scaledPlayerY;
        
        updateMapTransform();
        highlightMarker(player);
        
        console.debug(`Centrov√°n√≠ na hr√°ƒçe: Game(${player.x}, ${player.y}) -> Pixel(${pixelX.toFixed(2)}, ${pixelY.toFixed(2)})`);
    }

    // Zobrazen√≠ tooltipu hr√°ƒçe
    function showPlayerTooltip(player, event) {
        if (!tooltip) return;
        
        const isSelfPlayer = window.user && player.steamId === window.user.id;
        const isFriend = player.steamId && friendsManager && friendsManager.isFriend(player.steamId);
        
        let tooltipHTML = `
            <div class="tooltip-title">
                ${player.name}
                ${isSelfPlayer ? '(Vy)' : ''}
                ${isFriend ? '<i class="fa-solid fa-user-friends friend-icon"></i>' : ''}
            </div>
        `;
        
        // Dino zobrazujeme pouze pro sebe a p≈ô√°tele
        if (isSelfPlayer || isFriend) {
            tooltipHTML += `<div>${player.dino}</div>`;
            
            if (player.growth) {
                const displayGrowth = calculateDisplayGrowth(player.growth);
                tooltipHTML += `<div>R≈Øst: ${displayGrowth}%</div>`;
            }
        }
        
        if (player.x && (isSelfPlayer || window.user?.isAdmin || isFriend)) {
            tooltipHTML += `<div>Pozice: ${Math.round(player.x)}, ${Math.round(player.y)}</div>`;
        }
        
        if ((isSelfPlayer || isFriend) && (player.health !== undefined || player.hunger !== undefined || player.thirst !== undefined)) {
            tooltipHTML += `<div class="tooltip-stats visible">`;
            
            if (player.health !== undefined) {
                const healthPercent = Math.round(player.health * 100);
                tooltipHTML += `
                    <div class="stat-bar health-bar">
                        <div class="stat-bar-fill" style="width: ${healthPercent}%"></div>
                    </div>
                    <div class="stat-label">
                        <span>Zdrav√≠</span>
                        <span>${healthPercent}%</span>
                    </div>
                `;
            }
            
            if (player.hunger !== undefined) {
                const hungerPercent = Math.round(player.hunger * 100);
                tooltipHTML += `
                    <div class="stat-bar hunger-bar">
                        <div class="stat-bar-fill" style="width: ${hungerPercent}%"></div>
                    </div>
                    <div class="stat-label">
                        <span>Hlad</span>
                        <span>${hungerPercent}%</span>
                    </div>
                `;
            }
            
            if (player.thirst !== undefined) {
                const thirstPercent = Math.round(player.thirst * 100);
                tooltipHTML += `
                    <div class="stat-bar thirst-bar">
                        <div class="stat-bar-fill" style="width: ${thirstPercent}%"></div>
                    </div>
                    <div class="stat-label">
                        <span>≈Ω√≠ze≈à</span>
                        <span>${thirstPercent}%</span>
                    </div>
                `;
            }
            
            tooltipHTML += `</div>`;
        }
        
        tooltip.innerHTML = tooltipHTML;
        tooltip.style.opacity = '1';
        positionTooltip(event);
    }

    // Pozicov√°n√≠ tooltipu
    function positionTooltip(event) {
        if (!tooltip || !mapContainer) return;
        
        const rect = mapContainer.getBoundingClientRect();
        const x = event.clientX - rect.left;
        const y = event.clientY - rect.top;
        
        tooltip.style.left = `${x + 10}px`;
        tooltip.style.top = `${y - 10}px`;
    }

    // Skryt√≠ tooltipu
    function hideTooltip() {
        if (tooltip) {
            tooltip.style.opacity = '0';
        }
    }

    // Filtrace marker≈Ø podle typu dinosaura
    function filterMarkers() {
        const checkedFilters = Array.from(document.querySelectorAll('.dino-filter:checked')).map(cb => cb.value);
        
        document.querySelectorAll('.player-marker').forEach(marker => {
            const playerId = marker.dataset.playerId;
            const player = playersData.find(p => (p.steamId || p.name) === playerId);
            
            if (player) {
                const dinoType = getDinosaurType(player.dino);
                marker.style.display = checkedFilters.includes(dinoType) ? 'block' : 'none';
            }
        });
        
        updatePlayersList();
    }

    // Filtrace hr√°ƒç≈Ø podle jm√©na
    function filterPlayers() {
        const searchTerm = searchPlayer ? searchPlayer.value.toLowerCase() : '';
        
        filteredPlayersData = playersData.filter(player => {
            const matchesSearch = !searchTerm || player.name.toLowerCase().includes(searchTerm);
            const checkedFilters = Array.from(document.querySelectorAll('.dino-filter:checked')).map(cb => cb.value);
            const dinoType = getDinosaurType(player.dino);
            const matchesFilter = checkedFilters.includes(dinoType);
            
            return matchesSearch && matchesFilter;
        });
        
        updatePlayersList();
        
        document.querySelectorAll('.player-marker').forEach(marker => {
            const playerId = marker.dataset.playerId;
            const isVisible = filteredPlayersData.some(p => (p.steamId || p.name) === playerId);
            marker.style.display = isVisible ? 'block' : 'none';
        });
    }

    // Aktualizace seznamu hr√°ƒç≈Ø
    function updatePlayersList() {
        if (!playersContainer) return;
        
        const playersToShow = filteredPlayersData.length > 0 ? filteredPlayersData : playersData;
        
        if (playersToShow.length === 0) {
            playersContainer.innerHTML = '<div id="no-players-message">≈Ω√°dn√≠ hr√°ƒçi online</div>';
            return;
        }
        
        playersContainer.innerHTML = playersToShow.map(player => {
            const isSelfPlayer = window.user && player.steamId === window.user.id;
            const isFriend = player.steamId && friendsManager && friendsManager.isFriend(player.steamId);
            const dinoType = getDinosaurType(player.dino);
            
            let playerClass = 'player-item';
            if (isSelfPlayer) playerClass += ' player-self';
            if (isFriend) playerClass += ' player-friend';
            
            let playerHTML = `
                <div class="${playerClass}" onclick="centerOnPlayer(${JSON.stringify(player).replace(/"/g, '&quot;')})">
                    <div class="player-name">
                        ${player.name}
                        ${isSelfPlayer ? '(Vy)' : ''}
                        ${isFriend ? '<i class="fa-solid fa-user-friends friend-icon"></i>' : ''}
                    </div>
            `;
            
            // Zobrazit dino a r≈Øst pouze pro sebe a p≈ô√°tele
            if (isSelfPlayer || isFriend) {
                playerHTML += `
                    <div class="player-details">
                        <span>${player.dino}</span>
                        ${player.growth ? `<span>R≈Øst: ${calculateDisplayGrowth(player.growth)}%</span>` : ''}
                    </div>
                `;
                
                // Statistiky
                if (player.health !== undefined || player.hunger !== undefined || player.thirst !== undefined) {
                    playerHTML += '<div class="player-stats">';
                    
                    if (player.health !== undefined) {
                        const healthPercent = Math.round(player.health * 100);
                        playerHTML += `
                            <div class="stat-bar health-bar">
                                <div class="stat-bar-fill" style="width: ${healthPercent}%"></div>
                            </div>
                            <div class="stat-label">
                                <span>Zdrav√≠</span>
                                <span>${healthPercent}%</span>
                            </div>
                        `;
                    }
                    
                    if (player.hunger !== undefined) {
                        const hungerPercent = Math.round(player.hunger * 100);
                        playerHTML += `
                            <div class="stat-bar hunger-bar">
                                <div class="stat-bar-fill" style="width: ${hungerPercent}%"></div>
                            </div>
                            <div class="stat-label">
                                <span>Hlad</span>
                                <span>${hungerPercent}%</span>
                            </div>
                        `;
                    }
                    
                    if (player.thirst !== undefined) {
                        const thirstPercent = Math.round(player.thirst * 100);
                        playerHTML += `
                            <div class="stat-bar thirst-bar">
                                <div class="stat-bar-fill" style="width: ${thirstPercent}%"></div>
                            </div>
                            <div class="stat-label">
                                <span>≈Ω√≠ze≈à</span>
                                <span>${thirstPercent}%</span>
                            </div>
                        `;
                    }
                    
                    playerHTML += '</div>';
                }
            }
            
            playerHTML += '</div>';
            
            return playerHTML;
        }).join('');
        
        if (playerCount) {
            playerCount.textContent = `(${playersToShow.length})`;
        }
        
        // Aktualizovat statistiky dinosaur≈Ø
        updateDinoStats();
    }

    // Nov√° funkce pro aktualizaci statistik dinosaur≈Ø
    function updateDinoStats() {
        if (!dinoStatsContainer) return;
        
        const dinoCount = {};
        
        playersData.forEach(player => {
            if (player.dino) {
                if (!dinoCount[player.dino]) {
                    dinoCount[player.dino] = 0;
                }
                dinoCount[player.dino]++;
            }
        });
        
        const sortedDinos = Object.entries(dinoCount).sort((a, b) => b[1] - a[1]);
        
        if (sortedDinos.length === 0) {
            dinoStatsContainer.innerHTML = '<div style="text-align: center; color: #aaa; padding: 10px;">≈Ω√°dn√≠ dinosau≈ôi online</div>';
            return;
        }
        
        dinoStatsContainer.innerHTML = sortedDinos.map(([dino, count]) => {
            const dinoType = getDinosaurType(dino);
            let typeIcon = '';
            
            if (dinoType === 'carnivore') {
                typeIcon = '<i class="fa-solid fa-drumstick-bite" style="color: var(--carnivore-color);"></i>';
            } else if (dinoType === 'herbivore') {
                typeIcon = '<i class="fa-solid fa-leaf" style="color: var(--herbivore-color);"></i>';
            } else {
                typeIcon = '<i class="fa-solid fa-circle" style="color: var(--other-color);"></i>';
            }
            
            return `
                <div class="dino-item">
                    <span>${typeIcon} ${dino}</span>
                    <span style="font-weight: bold;">${count}</span>
                </div>
            `;
        }).join('');
    }

    // NOV√Å funkce - zobrazen√≠ cache stavu
    function updateCacheStatus(meta) {
        let cacheIndicator = document.getElementById('cache-indicator');
        if (!cacheIndicator) {
            cacheIndicator = document.createElement('div');
            cacheIndicator.id = 'cache-indicator';
            cacheIndicator.style.cssText = `
                position: absolute;
                top: 80px;
                right: 20px;
                background-color: rgba(0, 0, 0, 0.8);
                color: white;
                padding: 5px 10px;
                border-radius: 15px;
                font-size: 12px;
                z-index: 100;
                display: none;
            `;
            document.body.appendChild(cacheIndicator);
        }
        
        if (meta.fromCache) {
            const ageSeconds = Math.round(meta.cacheAge / 1000);
            const ageText = ageSeconds < 60 ? `${ageSeconds}s` : `${Math.round(ageSeconds / 60)}m`;
            
            cacheIndicator.textContent = `üìã Cache (${ageText})`;
            cacheIndicator.style.display = 'block';
            cacheIndicator.style.backgroundColor = ageSeconds > 60 ? 'rgba(255, 152, 0, 0.8)' : 'rgba(76, 175, 80, 0.8)';
            
            setTimeout(() => {
                cacheIndicator.style.display = 'none';
            }, 3000);
        } else {
            cacheIndicator.style.display = 'none';
        }
    }

    // OPRAVEN√Å aktualizace dat ze serveru - pou≈æ√≠v√° kombinovan√Ω endpoint
    async function refreshData() {
        try {
            if (playerLoading) playerLoading.style.display = 'block';
            if (noPlayersMessage) noPlayersMessage.style.display = 'none';
            
            // Pou≈æ√≠t kombinovan√Ω endpoint pro zamezen√≠ RCON konflikt≈Ø
            const response = await fetch(`${API_URL}/combined-data`, {
                method: 'GET',
                headers: {
                    'Cache-Control': 'no-cache'
                },
                credentials: 'include'
            });
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const result = await response.json();
            playersData = result.players || [];
            filteredPlayersData = [...playersData];
            
            // Zobrazen√≠ cache informac√≠
            if (result.meta && result.meta.playerDataFromCache) {
                updateCacheStatus({ 
                    fromCache: true, 
                    cacheAge: result.meta.playerCacheAge || 0 
                });
            }
            
            // Aktualizace poƒçtu hr√°ƒç≈Ø
            if (onlineCount) {
                onlineCount.textContent = playersData.length;
            }
            
            clearMarkers();
            
            playersData.forEach(player => {
                if (player.x && player.y) {
                    addPlayerMarker(player);
                }
            });
            
            updatePlayersList();
            filterPlayers();
            
            // D≈ÆLE≈ΩIT√â - aktualizace dat pro friends manager
            window.players = playersData;
            window.playersData = playersData;
            
            if (friendsManager) {
                await friendsManager.loadFriendsFromAPI();
                friendsManager.updateFriendsDisplay();
            }
            
            console.log(`Naƒçteno ${playersData.length} hr√°ƒç≈Ø${result.fromCache ? ' (z cache)' : ''}`);
            
        } catch (error) {
            console.error('Chyba p≈ôi naƒç√≠t√°n√≠ dat:', error);
            
            // Fallback na separ√°tn√≠ endpointy pokud kombinovan√Ω sel≈æe
            try {
                console.log('Fallback na separ√°tn√≠ API endpointy...');
                await refreshDataSeparate();
            } catch (fallbackError) {
                console.error('Fallback tak√© selhal:', fallbackError);
                
                showToast('Chyba p≈ôi naƒç√≠t√°n√≠ dat ze serveru', 'error');
            }
            
        } finally {
            if (playerLoading) playerLoading.style.display = 'none';
        }
    }

    // NOV√Å fallback funkce pro separ√°tn√≠ naƒç√≠t√°n√≠
    async function refreshDataSeparate() {
        console.log('üîÑ Fallback: Naƒç√≠t√°m data separ√°tnƒõ...');
        
        // Mal√© zpo≈ædƒõn√≠ mezi po≈æadavky pro zamezen√≠ RCON konfliktu
        const playersResponse = await fetch(`${API_URL}/playerlist`, {
            method: 'GET',
            headers: { 'Cache-Control': 'no-cache' },
            credentials: 'include'
        });
        
        if (!playersResponse.ok) {
            throw new Error(`Players API error: ${playersResponse.status}`);
        }
        
        const playersResult = await playersResponse.json();
        playersData = playersResult.players || [];
        filteredPlayersData = [...playersData];
        
        // Zobrazen√≠ cache informac√≠
        if (playersResult.meta) {
            updateCacheStatus(playersResult.meta);
        }
        
        // Aktualizace poƒçtu hr√°ƒç≈Ø
        if (onlineCount) {
            onlineCount.textContent = playersData.length;
        }
        
        clearMarkers();
        
        playersData.forEach(player => {
            if (player.x && player.y) {
                addPlayerMarker(player);
            }
        });
        
        updatePlayersList();
        filterPlayers();
        
        // Aktualizace dat pro friends manager
        window.players = playersData;
        window.playersData = playersData;
        
        if (friendsManager) {
            await friendsManager.loadFriendsFromAPI();
            friendsManager.updateFriendsDisplay();
        }
        
        console.log(`‚úÖ Fallback √∫spƒõ≈°n√Ω: ${playersData.length} hr√°ƒç≈Ø`);
    }

    // Kontrola p≈ôihl√°≈°en√≠ u≈æivatele
    async function checkUserLogin() {
        try {
            const response = await fetch(`${API_URL}/user`);
            if (response.ok) {
                const userData = await response.json();
                if (userData.success && userData.user) {
                    window.user = userData.user;
                    updateUserInterface(userData.user);
                    
                    // Inicializace friends manageru po p≈ôihl√°≈°en√≠
                    if (!friendsManager) {
                        friendsManager = new FriendsManager();
                        window.friendsManager = friendsManager;
                    }
                }
            }
        } catch (error) {
            console.error('Chyba p≈ôi kontrole p≈ôihl√°≈°en√≠:', error);
        }
    }

    // Aktualizace u≈æivatelsk√©ho rozhran√≠
    function updateUserInterface(user) {
        if (authPanel) {
            const p = authPanel.querySelector('p');
            const actions = authPanel.querySelector('.auth-panel-actions');
            if (p) p.style.display = 'none';
            if (actions) actions.style.display = 'none';
        }
        
        if (userInfo) {
            userInfo.style.display = 'block';
        }
        
        if (userName) {
            userName.textContent = user.displayName || user.name;
        }
        
        if (adminBadge) {
            adminBadge.style.display = user.isAdmin ? 'inline' : 'none';
        }
        
        if (friendsPanel) {
            friendsPanel.style.display = 'block';
        }
    }

    // Odhl√°≈°en√≠ u≈æivatele
    async function logout() {
        try {
            const response = await fetch(`${API_URL}/logout`, { method: 'GET' });
            if (response.ok) {
                window.user = null;
                location.reload();
            }
        } catch (error) {
            console.error('Chyba p≈ôi odhla≈°ov√°n√≠:', error);
        }
    }

    // Ovl√°d√°n√≠ mapy my≈°√≠ s aktualizac√≠ rozmƒõr≈Ø
    function setupMapControls() {
        if (!mapContainer) return;

        // Zoom koleƒçkem my≈°i
        mapContainer.addEventListener('wheel', function(e) {
            e.preventDefault();
            
            const rect = mapContainer.getBoundingClientRect();
            const mouseX = e.clientX - rect.left - rect.width / 2;
            const mouseY = e.clientY - rect.top - rect.height / 2;
            
            const oldScale = mapScale;
            const zoomFactor = 0.1;
            
            if (e.deltaY < 0) {
                mapScale = Math.min(mapScale + zoomFactor, 3);
            } else {
                mapScale = Math.max(mapScale - zoomFactor, 0.5);
            }
            
            const scaleChange = mapScale / oldScale;
            mapTranslateX = mouseX + scaleChange * (mapTranslateX - mouseX);
            mapTranslateY = mouseY + scaleChange * (mapTranslateY - mouseY);
            
            updateMapTransform();
        });

        // Drag pro pohyb mapy
        mapContainer.addEventListener('mousedown', function(e) {
            if (e.target.classList.contains('player-marker')) return;
            
            isDragging = true;
            lastMouseX = e.clientX;
            lastMouseY = e.clientY;
            mapContainer.style.cursor = 'grabbing';
            e.preventDefault();
        });

        document.addEventListener('mousemove', function(e) {
            if (!isDragging) return;
            
            const deltaX = e.clientX - lastMouseX;
            const deltaY = e.clientY - lastMouseY;
            
            mapTranslateX += deltaX;
            mapTranslateY += deltaY;
            
            lastMouseX = e.clientX;
            lastMouseY = e.clientY;
            
            updateMapTransform();
        });

        document.addEventListener('mouseup', function() {
            if (isDragging) {
                isDragging = false;
                mapContainer.style.cursor = 'move';
            }
        });

        // Touch ovl√°d√°n√≠ pro mobily
        let lastTouchDistance = 0;
        let lastTouchX = 0;
        let lastTouchY = 0;

        mapContainer.addEventListener('touchstart', function(e) {
            if (e.touches.length === 1) {
                lastTouchX = e.touches[0].clientX;
                lastTouchY = e.touches[0].clientY;
            } else if (e.touches.length === 2) {
                const dx = e.touches[0].clientX - e.touches[1].clientX;
                const dy = e.touches[0].clientY - e.touches[1].clientY;
                lastTouchDistance = Math.sqrt(dx * dx + dy * dy);
            }
            e.preventDefault();
        });

        mapContainer.addEventListener('touchmove', function(e) {
            if (e.touches.length === 1) {
                const deltaX = e.touches[0].clientX - lastTouchX;
                const deltaY = e.touches[0].clientY - lastTouchY;
                
                mapTranslateX += deltaX;
                mapTranslateY += deltaY;
                
                lastTouchX = e.touches[0].clientX;
                lastTouchY = e.touches[0].clientY;
                
                updateMapTransform();
            } else if (e.touches.length === 2) {
                const dx = e.touches[0].clientX - e.touches[1].clientX;
                const dy = e.touches[0].clientY - e.touches[1].clientY;
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                if (lastTouchDistance > 0) {
                    const scaleChange = distance / lastTouchDistance;
                    mapScale = Math.max(0.5, Math.min(3, mapScale * scaleChange));
                    updateMapTransform();
                }
                
                lastTouchDistance = distance;
            }
            e.preventDefault();
        });

        // Aktualizovat p≈ôi zmƒõnƒõ velikosti okna jen ≈°k√°lov√°n√≠
        window.addEventListener('resize', function() {
            initializeMap();
        });
    }

    // Ovl√°d√°n√≠ tlaƒç√≠tky
    function setupControlButtons() {
        const zoomInBtn = document.getElementById('zoom-in');
        const zoomOutBtn = document.getElementById('zoom-out');
        const resetViewBtn = document.getElementById('reset-view');

        if (zoomInBtn) {
            zoomInBtn.addEventListener('click', function() {
                mapScale = Math.min(mapScale + 0.2, 3);
                updateMapTransform();
            });
        }

        if (zoomOutBtn) {
            zoomOutBtn.addEventListener('click', function() {
                mapScale = Math.max(mapScale - 0.2, 0.5);
                updateMapTransform();
            });
        }

        if (resetViewBtn) {
            resetViewBtn.addEventListener('click', function() {
                initializeMap();
            });
        }
    }

    // Toast notifikace
    function showToast(message, type = 'info') {
        const toast = document.createElement('div');
        toast.classList.add('toast', type);
        
        let icon = 'fa-info-circle';
        if (type === 'success') icon = 'fa-check-circle';
        if (type === 'error') icon = 'fa-exclamation-circle';
        
        toast.innerHTML = `<i class="fa-solid ${icon}"></i> ${message}`;
        
        toastContainer.appendChild(toast);
        
        setTimeout(() => {
            toast.remove();
        }, 5300);
    }

    // Event listenery pro vyhled√°v√°n√≠ a filtry
    function setupEventListeners() {
        
        if (logoutBtn) {
            logoutBtn.addEventListener('click', logout);
        }

        if (searchPlayer) {
            searchPlayer.addEventListener('input', filterPlayers);
        }

        // Event listenery pro filtry dinosaur≈Ø
        document.querySelectorAll('.dino-filter').forEach(checkbox => {
            checkbox.addEventListener('change', filterMarkers);
        });

        // Event listenery pro spr√°vu p≈ô√°tel
        if (addFriendBtn) {
            addFriendBtn.addEventListener('click', () => {
                friendsManager.showAddFriendDialog();
            });
        }

        if (friendDialogCancel) {
            friendDialogCancel.addEventListener('click', () => {
                friendsManager.hideAddFriendDialog();
            });
        }

        if (friendDialogOverlay) {
            friendDialogOverlay.addEventListener('click', () => {
                friendsManager.hideAddFriendDialog();
            });
        }

        if (friendDialogAdd) {
            friendDialogAdd.addEventListener('click', () => {
                friendsManager.addSelectedFriends();
            });
        }
    }
    
    // Inicializace aplikace
    function init() {
        console.log('Inicializace mapov√©ho rozhran√≠ pro Gateway mapu...');
        console.log('üìç Kalibrace podle islemaps.com');
        
        // Inicializace mapy na v√Ωchoz√≠ pozici
        initializeMap();
        
        // Nastaven√≠ ovl√°d√°n√≠ mapy
        setupMapControls();
        
        // Nastaven√≠ tlaƒç√≠tek
        setupControlButtons();
        
        // Nastaven√≠ event listener≈Ø
        setupEventListeners();
        
        // Kontrola p≈ôihl√°≈°en√≠ u≈æivatele
        checkUserLogin();
        
        // Prvn√≠ naƒçten√≠ dat
        refreshData();
        
        console.log('Mapov√© rozhran√≠ inicializov√°no pro Gateway mapu 620x620px');
        console.log('Kalibrace: rozmez√≠ -690,000 a≈æ +865,000 pro X osu, -725,000 a≈æ +690,000 pro Y osu');
    }

    // Automatick√° aktualizace ka≈æd√Ωch 60 sekund
    setInterval(() => {
        refreshData();
    }, AUTO_REFRESH_INTERVAL * 1000);

    // Spu≈°tƒõn√≠ inicializace
    init();

    // Glob√°ln√≠ funkce pro kompatibilitu
    window.positionMarker = positionMarker;
    window.clearMarkers = clearMarkers;
    window.addPlayerMarker = addPlayerMarker;
    window.highlightMarker = highlightMarker;
    window.unhighlightMarker = unhighlightMarker;
    window.centerOnPlayer = centerOnPlayer;
    window.showPlayerTooltip = showPlayerTooltip;
    window.positionTooltip = positionTooltip;
    window.hideTooltip = hideTooltip;
    window.filterMarkers = filterMarkers;
    window.filterPlayers = filterPlayers;
    window.updateMapTransform = updateMapTransform;
    window.showToast = showToast;
    window.friendsManager = friendsManager;
    window.updatePlayersList = updatePlayersList;
    window.players = playersData;
    window.playersData = playersData;
    window.updateMapDimensions = updateMapDimensions;
    window.calculateDisplayGrowth = calculateDisplayGrowth;
});
    </script>
</body>
</html>